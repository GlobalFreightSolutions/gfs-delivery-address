<link rel="import" href="../polymer/polymer.html" />

<dom-module id="gfs-delivery-address">
	<style>
		div, span, h3 {
			font-family: "Raleway", "Helvetica Neue", Verdana, Arial, sans-serif;
		}
		.infoText {
			margin-top: 0.5em;
			margin-bottom: 0.5em;
		}
		#container {
			padding: 10px;
			/*margin: 10px;*/
			min-height: 120px;
			background-color: #FAFAFA;
			border-radius: 3px;
			box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14), 0 1px 5px 0 rgba(0, 0, 0, 0.12), 0 3px 1px -2px rgba(0, 0, 0, 0.2);
			border: 1px solid #FAFAFA;
		}
		h3 {
			margin-top: 0px;
		}
	</style>


	<template>
        <div id="container">  
            <h3>Your Delivery</h3>      
            <div class="info"> 
                <template is="dom-if" if="{{overrideStreetAddress}}">
                    <div class="infoText"><strong>Your order will be delivered to:</strong> {{overrideStreetAddress}}</div>
                </template>
                <template is="dom-if" if="{{!overrideStreetAddress}}">
                    <div class="infoText"><strong>Your order will be delivered to:</strong> {{defaultStreetAddress}}</div>
                </template>
				<template is="dom-if" if="{{_visible}}">
					<div class="infoText"><strong>You have selected the:</strong> {{selectedService}}</div>
				</template>
            </div>
        </div>


    </template>

    <script>

        Polymer({
            is: "gfs-delivery-address",

            properties: {
                defaultStreetAddress: {
                	type: String
                },
                overrideStreetAddress: {
                    type: String,
                    value: null
                },
                _visible: {
                	type: Boolean,
                	value: false
                },
                selectedService: {
                	type: String
                }

            },
            listeners: {

            },
            ready: function() {
            	window.addEventListener('droppoint-changed', this.onDroppointChanged.bind(this), false);
            	window.addEventListener('getStandardSelectedService', this._getStandardSelectedService.bind(this), false);
            	window.addEventListener('getCalendarSelectedService', this._getCalendarSelectedService.bind(this), false);
            	window.addEventListener('getDroppointSelectedService', this._getDroppointSelectedService.bind(this), false);
            },
            onDroppointChanged: function (e) {
            	this.set("droppointData", e.detail);
            	if (this.droppointData.chosen === true) {
            		this.overrideStreetAddress = this.droppointData.geoLocation.addressLines + ', ' + this.droppointData.geoLocation.town + ', ' + this.droppointData.geoLocation.postCode;
            	}
            	else {
            		this.overrideStreetAddress = this.initialAddress;
            	}
            },
           _getStandardSelectedService: function (e) {
            	this._visible = e.detail.checked;
            	this.selectedService = e.detail.service + ' service, ' + '(' + e.detail.currencySymbol + e.detail.shipping + ')' + ', ' + 'Est. arrival: ' + moment(e.detail.expDeliveryDateStart).format("ddd, Do MMMM") + ' - ' + moment(e.detail.expDeliveryDateEnd).format("ddd, Do MMMM");
            },
            _getCalendarSelectedService: function (e) {
            	var getTheTime = new Date(e.detail.expDeliveryDateEnd);

            	this._visible = e.detail.checked;
            	this.selectedService = e.detail.service + ' service, ' + '(' + e.detail.currencySymbol + e.detail.shipping + ')' + ', ' + 'Delivery on: ' + moment(e.detail.expDeliveryDateStart).format("ddd, Do MMMM") + ' by ' + (getTheTime.getUTCHours() + 1) + ':' + (getTheTime.getUTCMinutes() < '10' ? '0' : '') + getTheTime.getUTCMinutes();
            },
            _getDroppointSelectedService: function (e) {
            	var startDate = new Date(e.detail.expDeliveryDateStart).setHours(0, 0, 0);
            	var endDate = new Date(e.detail.expDeliveryDateEnd).setHours(0, 0, 0);

            	this._visible = e.detail.checked;

            	if (startDate === endDate) {
            		this.selectedService = e.detail.service + ' service, ' + '(' + e.detail.currencySymbol + e.detail.shipping + ')' + ', ' + 'Est. arrival: ' + moment(e.detail.expDeliveryDateStart).format("ddd, Do MMMM");
            	}
            	else {
            		this.selectedService = e.detail.service + ' service, ' + '(' + e.detail.currencySymbol + e.detail.shipping + ')' + ', ' + 'Est. arrival: ' + moment(e.detail.expDeliveryDateStart).format("ddd, Do MMMM") + ' - ' + moment(e.detail.expDeliveryDateEnd).format("ddd, Do MMMM");
            	}
            },
        });
    </script>
</dom-module>